{% extends "Messenger/base.html" %}
{% load static %}
{% block title %}Чати{% endblock %}

{% block links %}
{{ block.super }}
<link rel="icon" type="image/svg+xml" href="{% static 'images/favicon.svg' %}">
<link rel="stylesheet" href="{% static 'css/chats.css' %}">

<style>
    .chat-window { display: flex; flex-direction: column; height: 100%; width: 100%; background-color: #fff; overflow: hidden; }
    .chat-header { display: flex; align-items: center; padding: 10px 20px; border-bottom: 1px solid #e0e0e0; background-color: white; flex-shrink: 0; height: 72px; }
    .chat-header .back-arrow { cursor: pointer; }
    .chat-header .group-avatar { margin-left: 16px; width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    .chat-header .header-info { display: flex; flex-direction: column; justify-content: center; margin-left: 10px; height: 100%; }
    .chat-header .header-title { font-size: 16px; font-weight: 600; color: #070A1C; line-height: 1.2; }
    .chat-header .header-members { font-size: 12px; font-weight: 400; color: #81818D; line-height: 1.2; }

    .messages-container { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; background-color: white; border: none; scrollbar-width: none; -ms-overflow-style: none; }
    .messages-container::-webkit-scrollbar { display: none; }

    .message { display: flex; flex-direction: column; margin-bottom: 12px; max-width: 70%; width: fit-content; height: auto; gap: 5px; border-radius: 6px; padding: 10px; border: 1px solid #E9E5EE; }
    .message.sent { align-self: flex-end; font-family: 'GT Walsheim Pro', sans-serif; font-weight: 400; font-size: 14px; line-height: 1.5; color: #070A1C; background-color: #e6eaf0; }
    .message.received { align-self: flex-start; font-family: 'GT Walsheim Pro', sans-serif; font-weight: 400; font-size: 14px; line-height: 1.5; color: #070A1C; background-color: white; }
    .message-author { font-weight: bold; margin-bottom: 4px; color: #007bff; }
    .message-body { display: flex; align-items: flex-end; gap: 8px; }
    .message-content { font-size: 0.95em; line-height: 1.4; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; }
    .message-content img { max-width: 300px; height: auto; border-radius: 8px; margin-top: 5px; }
    .message-time { font-family: 'GT Walsheim Pro', sans-serif; font-weight: 400; font-size: 10px; line-height: 1; color: #81818D; white-space: nowrap; padding-bottom: 2px; }

    .message-form-container { padding: 10px 15px; background-color: white; flex-shrink: 0; display: flex; justify-content: center; }
    #message-form { display: flex; align-items: center; gap: 24px; width: 532px; height: 42px; }
    #message-input { flex: 1; min-width: 0; height: 100%; border-radius: 10px; border: 1px solid #CDCED2; padding: 10px 16px; font-family: 'GT Walsheim Pro', sans-serif; font-weight: 400; font-size: 16px; color: #81818D; background-color: #FFFFFF; box-sizing: border-box; outline: none; }
    #send-button { padding: 0; border: none; background-color: #543C52; color: white; border-radius: 50%; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; flex-shrink: 0; }
    #send-button img { width: 20px; height: 20px; }
    #message-form > img { width: 40px; height: 40px; cursor: pointer; flex-shrink: 0; }

    .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
    .modal.show { display: flex; }

    .modal-content-custom { display: none; background: #FFFFFF; border-radius: 20px; padding: 24px 44px 44px 44px; flex-direction: column; position: relative; max-height: 90vh; box-sizing: border-box; }
    .modal-content-custom.active-step { display: flex; }
    .modal-content-custom .close { position: absolute; top: 24px; right: 24px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }

    .modal-header-custom { font-family: 'GT Walsheim Pro', sans-serif; font-weight: 500; font-size: 34px; line-height: 100%; letter-spacing: -0.01em; text-align: center; color: #070A1C; margin: 0; margin-bottom: 24px; }

    .modal-counter {
        font-family: 'GT Walsheim Pro', sans-serif;
        font-weight: 500;
        font-size: 14px;
        line-height: 100%;
        letter-spacing: -0.01em;
        color: #81818D;
        text-align: left;
        margin-bottom: 12px; 
    }

    .modal-user-list { width: 402px; height: 432px; display: flex; flex-direction: column; gap: 0; overflow-y: auto; padding-right: 10px; margin: 0 auto; margin-bottom: 24px; }
    .modal-user-item-custom { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px 0; border-bottom: 1px solid #E2E0E8; }
    .modal-user-item-custom:first-child { border-top: 1px solid #E2E0E8; }
    .modal-user-item-custom .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    .modal-user-item-custom p { flex-grow: 1; margin: 0; font-family: 'GT Walsheim Pro', sans-serif; font-size: 15px; color: #070A1C; }
    .modal-user-item-custom input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; cursor: pointer; accent-color: #543C52; }

    #modal-step-1-content, #modal-step-2-content { width: 490px; }

    .modal-label {
        font-family: 'GT Walsheim Pro', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 100%;
        letter-spacing: -0.007em;
        color: #070A1C;
        display: block;
        margin-bottom: 8px; 
        text-align: left;
    }

    .modal-input {
        width: 402px;
        height: 42px;
        border-radius: 10px;
        padding: 10px 16px;
        border: 1px solid #CDCED2;
        background: #FFFFFF;
        box-sizing: border-box;
        font-family: 'GT Walsheim Pro', sans-serif;
        font-size: 16px;
        color: #070A1C;
        margin: 0 auto 24px auto;
        outline: none;
    }

    .modal-input::placeholder { color: #81818D; }

    #group-avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; align-self: center; cursor: pointer; margin-bottom: 12px; }

    #photoActionsContainer { display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 24px; margin: 0; margin-bottom: 24px; cursor: pointer; }
    .photo-action { display: flex; align-items: center; }
    .photo-action img { width: 20px; height: 20px; margin-right: 8px; }
    .photo-action p { margin: 0; font-family: 'GT Walsheim Pro', sans-serif; font-weight: 500; font-size: 16px; color: #543C52; }

    #selected-members-list-step2 {
        width: 402px;
        max-height: 158px;
        display: flex;
        flex-direction: column;
        gap: 0;
        overflow-y: auto;
        margin: 0 auto;
        margin-bottom: auto; /* Push buttons to the bottom */
        padding-right: 10px;
    }

    .selected-member-item { display: flex; align-items: center; gap: 12px; }
    .selected-member-item .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    .remove-member-icon { margin-left: auto; cursor: pointer; width: 24px; height: 24px; }

    .form-actions { display: flex; justify-content: flex-end; gap: 16px; margin-top: 24px; }
    .form-actions .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        border-radius: 1234px;
        padding: 10px 16px;
        font-family: 'GT Walsheim Pro', sans-serif;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        box-sizing: border-box;
    }

    .form-actions .btn-cancel { min-width: 100px; border: 1px solid #543C52; background-color: #FFFFFF; color: #543C52; }
    .form-actions .btn-next { min-width: 134px; border: none; background-color: #543C52; color: #FFFFFF; white-space: nowrap; }
    .form-actions .btn-next:disabled { background-color: #ccc; cursor: not-allowed; }
</style>

{% endblock %}

{% block content %}
<div class="content-container">
    <div class="left-frame">
        <div class="contacts-frame">
            <button id="create-group-chat-btn">
                <img src="{% static 'images/pluuuuuus.svg' %}" alt="Plus img">
                Створити груповий чат
            </button>
        </div>
        <div class="requests-frame">
            <div class="requests">
                <div class="requ">
                    <img src="{% static 'images/people.svg' %}" alt="People img">
                    <p>Контакти</p>
                </div>
            </div>
            <div class="search-frame">
                <img src="{% static 'images/search.svg' %}" alt="Search img">
                <input type="text" placeholder="Пошук">
            </div>
            <div class="contacts-list-frame">
                {% for user_data in all_users %}
                <div class="contacts-list-users-1" data-user-id="{{ user_data.user.id }}" style="cursor: pointer;">
                    {% if user_data.avatar and user_data.avatar.image and user_data.avatar.image.file %}
                        <img src="{{ user_data.avatar.image.file.url }}" alt="{{ user_data.user.username }}'s Avatar" class="avatar">
                    {% else %}
                        <img src="{% static 'images/avatar.png' %}" alt="Default Avatar" class="avatar">
                    {% endif %}
                    <p>{{ user_data.user.first_name }} {{ user_data.user.last_name }}</p>
                </div>
                {% empty %}
                <p>Немає контактів.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="middle-frame">
        <div class="preview-text">
            <h1>Почніть нове спілкування</h1>
            <p>Оберіть контакт або груповий чат зі списків<br>або створіть нову групу, щоб почати спілкування</p>
        </div>
        {% for post in user_posts %}
        <div class="post-frame">
            <div class="header-post-frame">
                 ...
            </div>
            <div class="post-content">
                 ...
            </div>
        </div>
        {% empty %}
        {% endfor %}
    </div>

    <div class="right-frame">
        <div class="right-frame-top">
            <div class="requ">
                <img src="{% static 'images/chat.svg' %}" alt="Chat img">
                <p class="messege-title">Повідомлення</p>
                <a href="#" class="see-title">Дивитись всі</a>
            </div>
            <div class="messages-list-frame">
                {% for chat in personal_chats %}
                <div class="user-messege-1" style="cursor: pointer;" onclick="window.location.href='{% url 'chat' chat.chat_pk %}'">
                    <img src="{% if chat.other_user_avatar_url %}{{ chat.other_user_avatar_url }}{% else %}{% static 'images/avatar.png' %}{% endif %}" alt="User Avatar">
                    <div class="user-info">
                        <p class="nick">{{ chat.other_user_name }}</p>
                    </div>
                </div>
                {% empty %}
                <p>У вас немає персональних чатів.</p>
                {% endfor %}
            </div>
        </div>
        <div class="right-frame-bottom">
            <div class="requ">
                <img src="{% static 'images/chat.svg' %}" alt="Chat img">
                <p class="messege-title">Групові чати</p>
                <a href="#" class="see-title">Дивитись всі</a>
            </div>
            <div class="messages-list-frame">
                {% for group in group_chats %}
                <div class="user-messege-1" style="cursor: pointer;" onclick="window.location.href='{% url 'chat' group.pk %}'">
                    <img src="{% if group.avatar %}{{ group.avatar.url }}{% else %}{% static 'images/avatar.png' %}{% endif %}" alt="Group Avatar">
                    <div class="user-info">
                        <p class="nick">{{ group.name }}</p>
                    </div>
                </div>
                {% empty %}
                <p>Ви не перебуваєте в групових чатах.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="group-chat-modal" class="modal">
    <form id="create-group-chat-form">
        {% csrf_token %}
        <div id="modal-step-1-content" class="modal-content-custom active-step">
            <span class="close">×</span>
            <h2 class="modal-header-custom">Нова група</h2>
            <input type="text" id="user-search-input" class="modal-input" placeholder="Пошук контактів">
            
            <p id="members-counter" class="modal-counter">Вибрано: 0</p>
            
            <div id="modal-user-list-container" class="modal-user-list">
                {% for user_data in all_users %}
                    <div class="modal-user-item-custom" data-username="{{ user_data.user.first_name }} {{ user_data.user.last_name }}">
                        {% if user_data.avatar and user_data.avatar.image and user_data.avatar.image.file %}
                            <img src="{{ user_data.avatar.image.file.url }}" alt="Avatar" class="avatar">
                        {% else %}
                            <img src="{% static 'images/avatar.png' %}" alt="Avatar" class="avatar">
                        {% endif %}
                        <p>{{ user_data.user.first_name }} {{ user_data.user.last_name }}</p>
                        <input type="checkbox" name="members" value="{{ user_data.user.id }}"
                               data-username="{{ user_data.user.first_name }} {{ user_data.user.last_name }}"
                               data-avatar="{% if user_data.avatar and user_data.avatar.image and user_data.avatar.image.file %}{{ user_data.avatar.image.file.url }}{% else %}{% static 'images/avatar.png' %}{% endif %}">
                    </div>
                {% endfor %}
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="modal-cancel-btn-1">Скасувати</button>
                <button type="button" class="btn btn-next" id="modal-next-btn" disabled>Далі</button>
            </div>
        </div>

        <div id="modal-step-2-content" class="modal-content-custom">
            <span class="close">×</span>
            <h2 class="modal-header-custom">Нова група</h2>

            <input type="file" name="avatar" id="group-avatar-input" accept="image/*" style="display: none;">
            <img src="{% static 'images/gruppa.svg' %}" alt="Group Avatar Preview" id="group-avatar-preview">
                
            <div id="photoActionsContainer">
                <div class="photo-action">
                    <img src="{% static 'images/plucik.svg' %}" alt="Add Photo Icon">
                    <p>Додайте фото</p>
                </div>
                <div class="photo-action">
                    <img src="{% static 'images/miniphoto.svg' %}" alt="Choose Photo Icon">
                    <p>Оберіть фото</p>
                </div>
            </div>

            <label for="group-name" class="modal-label">Назва</label>
            <input type="text" id="group-name" name="group_name" required placeholder="Введіть назву" class="modal-input">
            
            <label class="modal-label">Учасники</label>
            <div id="selected-members-list-step2">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="modal-back-btn">Назад</button>
                <button type="submit" class="btn btn-next">Створити групу</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.contacts-list-users-1').forEach(contact => {
        contact.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            if (userId) {
                window.location.href = `/to_personal_chat/${userId}/`;
            }
        });
    });

    const modal = document.getElementById('group-chat-modal');
    const createGroupBtn = document.getElementById('create-group-chat-btn');
    const groupChatForm = document.getElementById('create-group-chat-form');
    
    if (!createGroupBtn || !modal || !groupChatForm) {
        console.error('Modal elements not found!');
        return;
    }
    
    const step1Content = document.getElementById('modal-step-1-content');
    const step2Content = document.getElementById('modal-step-2-content');
    const nextBtn = document.getElementById('modal-next-btn');
    const backBtn = document.getElementById('modal-back-btn');
    const cancelBtn1 = document.getElementById('modal-cancel-btn-1');
    const closeButtons = document.querySelectorAll('.modal .close');

    const userSearchInput = document.getElementById('user-search-input');
    const membersCounter = document.getElementById('members-counter');
    const userListContainer = document.getElementById('modal-user-list-container');
    const userItems = userListContainer.querySelectorAll('.modal-user-item-custom');
    
    const avatarPreview = document.getElementById('group-avatar-preview');
    const avatarInput = document.getElementById('group-avatar-input');
    const photoActions = document.getElementById('photoActionsContainer');
    const selectedMembersContainer = document.getElementById('selected-members-list-step2');

    function openModal() {
        resetModal();
        modal.classList.add('show');
    }

    function closeModal() {
        modal.classList.remove('show');
    }

    function goToStep2() {
        updateSelectedMembersList();
        step1Content.classList.remove('active-step');
        step2Content.classList.add('active-step');
    }

    function goToStep1() {
        step2Content.classList.remove('active-step');
        step1Content.classList.add('active-step');
    }

    function resetModal() {
        groupChatForm.reset();
        goToStep1();
        if (userSearchInput) userSearchInput.value = '';
        filterUsers();
        updateCounter();
        if (selectedMembersContainer) selectedMembersContainer.innerHTML = '';
        if (avatarPreview) avatarPreview.src = `{% static 'images/gruppa.svg' %}`;
    }

    createGroupBtn.addEventListener('click', openModal);
    if (nextBtn) nextBtn.addEventListener('click', goToStep2);
    if (backBtn) backBtn.addEventListener('click', goToStep1);
    if (cancelBtn1) cancelBtn1.addEventListener('click', closeModal);
    closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    function updateCounter() {
        if (!userListContainer || !membersCounter || !nextBtn) return;
        const checkedCount = userListContainer.querySelectorAll('input[type="checkbox"]:checked').length;
        membersCounter.textContent = `Вибрано: ${checkedCount}`;
        nextBtn.disabled = checkedCount === 0;
    }

    function filterUsers() {
        if (!userSearchInput || !userItems) return;
        const searchTerm = userSearchInput.value.toLowerCase();
        userItems.forEach(item => {
            const username = item.dataset.username.toLowerCase();
            item.style.display = username.includes(searchTerm) ? 'flex' : 'none';
        });
    }

    if (userListContainer) userListContainer.addEventListener('change', updateCounter);
    if (userSearchInput) userSearchInput.addEventListener('input', filterUsers);

    if (avatarPreview && avatarInput && photoActions) {
        [avatarPreview, photoActions].forEach(el => {
            el.addEventListener('click', () => avatarInput.click());
        });
        avatarInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                avatarPreview.src = URL.createObjectURL(file);
            }
        });
    }

    function updateSelectedMembersList() {
        if (!selectedMembersContainer || !userListContainer) return;
        selectedMembersContainer.innerHTML = '';
        const selectedCheckboxes = userListContainer.querySelectorAll('input[name="members"]:checked');
        selectedCheckboxes.forEach(checkbox => {
            const userId = checkbox.value;
            const username = checkbox.dataset.username;
            const avatarUrl = checkbox.dataset.avatar;

            const memberItem = document.createElement('div');
            memberItem.className = 'selected-member-item';
            memberItem.innerHTML = `
                <img src="${avatarUrl}" alt="Avatar" class="avatar">
                <p>${username}</p>
                <img src="{% static 'images/musorka.svg' %}" class="remove-member-icon" data-user-id="${userId}" alt="Remove">
            `;
            selectedMembersContainer.appendChild(memberItem);
        });
    }

    if (selectedMembersContainer) {
        selectedMembersContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-member-icon')) {
                const userId = e.target.dataset.userId;
                e.target.closest('.selected-member-item').remove();
                
                const checkboxToUncheck = userListContainer.querySelector(`input[value="${userId}"]`);
                if (checkboxToUncheck) {
                    checkboxToUncheck.checked = false;
                    updateCounter();
                }
            }
        });
    }

    groupChatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch("{% url 'create_group_chat' %}", {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.chat_url;
            } else {
                alert('Помилка створення групи: ' + (data.error || 'Невідома помилка'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Сталася мережева помилка. Спробуйте ще раз.');
        });
    });

    updateCounter();
});
</script>
{% endblock %}